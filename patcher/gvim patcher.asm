; Patches gvim.exe to fix character widths for the following options:
; set ambiwidth=double guifont=Fixedsys:cSHIFTJIS

; Last Change: 2015 April 13

format PE console

include 'win32.inc'

.text

	push	NULL
	push	FILE_ATTRIBUTE_NORMAL
	push	OPEN_EXISTING
	push	NULL
	push	FILE_SHARE_READ
	push	GENERIC_READ or GENERIC_WRITE
	push	file_name
	call	[CreateFileA]

	cmp	eax, INVALID_HANDLE_VALUE
	je	exit_process

	mov	ebx, eax

	; Patch at offset 1F9380h
	push	FILE_BEGIN
	push	NULL
	push	1F9380h
	push	eax
	call	[SetFilePointer]

	cmp	eax, INVALID_SET_FILE_POINTER
	je	exit_process

	push	NULL
	push	bytes
	push	new_data.size
	push	new_data
	push	ebx
	call	[WriteFile]

exit_process:
	push	0
	call	[ExitProcess]

alignz 4

file_name db 'gvim.exe', 0
alignz 4

new_data dd \
	00000000h, 00000000h, 00000000h, 00000000h,\
	00000000h, 00000000h, 00000000h, 00000000h,\
	00000000h, 00000000h, 00000000h, 00000000h,\
	00000080h, 0000009Fh, 000000A7h, 000000A8h,\
	000000B1h, 000000B1h, 000000B4h, 000000B4h,\
	000000B6h, 000000B6h, 000000D7h, 000000D7h,\
	000000F7h, 000000F7h, 00000180h, 00000191h,\
	00000194h, 000001C1h, 000001C3h, 000001F7h,\
	00000200h, 0000024Fh, 000002A9h, 000002C5h,\
	000002CAh, 000002CBh, 000002CDh, 000002CFh,\
	000002D2h, 000002D7h, 000002DFh, 000002E4h,\
	000002EAh, 000002FFh, 00000305h, 00000305h,\
	00000307h, 00000307h, 00000309h, 0000030Ah,\
	0000030Dh, 0000030Eh, 00000310h, 00000317h,\
	0000031Bh, 0000031Bh, 00000321h, 00000323h,\
	00000326h, 00000328h, 0000032Bh, 0000032Bh,\
	0000032Dh, 0000032Eh, 00000331h, 00000333h,\
	00000335h, 00000338h, 0000033Eh, 00000360h,\
	00000362h, 00000373h, 00000376h, 00000379h,\
	0000037Bh, 0000037Dh, 0000037Fh, 00000383h,\
	0000038Bh, 0000038Bh, 0000038Dh, 0000038Dh,\
	00000391h, 000003A9h, 000003B1h, 000003C1h,\
	000003C3h, 000003C9h, 000003CFh, 00000401h,\
	0000040Dh, 0000040Dh, 00000410h, 00000451h,\
	0000045Dh, 0000045Dh, 00000487h, 0000048Fh,\
	000004C5h, 000004C6h, 000004C9h, 000004CAh,\
	000004CDh, 000004CFh, 000004ECh, 000004EDh,\
	000004F6h, 000004F7h, 000004FAh, 0000070Eh,\
	00000710h, 000009F1h, 000009F4h, 00000E3Eh,\
	00000E40h, 000010FFh, 00001160h, 000011A2h,\
	000011A8h, 000011F9h, 00001200h, 000017DAh,\
	000017DCh, 0000180Ah, 0000180Fh, 00001E3Dh,\
	00001E40h, 00001E7Fh, 00001E86h, 00001EF1h,\
	00001EF4h, 00001F6Fh, 00001F74h, 00001FFFh,\
	00002010h, 00002010h, 00002015h, 00002016h,\
	00002018h, 00002019h, 0000201Ch, 0000201Dh,\
	00002020h, 00002021h, 00002025h, 00002026h,\
	0000202Fh, 00002030h, 0000203Bh, 0000203Bh,\
	0000204Ah, 00002069h, 00002071h, 00002073h,\
	0000208Fh, 0000209Fh, 000020B2h, 000020FFh,\
	00002103h, 00002103h, 00002116h, 00002116h,\
	00002121h, 00002121h, 0000212Bh, 0000212Bh,\
	00002139h, 00002152h, 00002160h, 00002193h,\
	000021D2h, 000021D2h, 000021D4h, 000021D4h,\
	000021EBh, 00002200h, 00002202h, 00002203h,\
	00002207h, 00002208h, 0000220Bh, 0000220Bh,\
	00002211h, 00002211h, 0000221Ah, 0000221Ah,\
	0000221Dh, 00002220h, 00002225h, 00002225h,\
	00002227h, 0000222Ch, 0000222Eh, 0000222Eh,\
	00002234h, 00002235h, 0000223Dh, 0000223Dh,\
	00002252h, 00002252h, 00002260h, 00002261h,\
	00002266h, 00002267h, 0000226Ah, 0000226Bh,\
	00002282h, 00002283h, 00002286h, 00002287h,\
	000022A5h, 000022A5h, 000022BFh, 000022BFh,\
	000022F2h, 00002301h, 00002303h, 00002304h,\
	00002308h, 0000230Fh, 00002311h, 0000231Fh,\
	00002322h, 00002328h, 0000232Bh, 00002503h,\
	0000250Ch, 0000250Ch, 0000250Fh, 0000250Fh,\
	00002513h, 00002514h, 00002517h, 00002517h,\
	0000251Bh, 0000251Dh, 00002520h, 00002520h,\
	00002523h, 00002523h, 00002528h, 00002528h,\
	0000252Bh, 0000252Ch, 0000252Fh, 00002530h,\
	00002533h, 00002534h, 00002537h, 00002538h,\
	0000253Bh, 0000253Ch, 0000253Fh, 0000253Fh,\
	00002542h, 00002542h, 0000254Bh, 0000254Bh,\
	00002596h, 000025A1h, 000025B2h, 000025B3h,\
	000025BCh, 000025BDh, 000025C6h, 000025C7h,\
	000025CBh, 000025CBh, 000025CEh, 000025CFh,\
	000025EFh, 00002638h, 0000263Dh, 0000265Fh,\
	00002668h, 00002668h, 0000266Ah, 0000266Ah,\
	0000266Dh, 0000266Dh, 0000266Fh, 00002933h,\
	00002936h, 00002984h, 00002987h, 000029F9h,\
	000029FCh, 00002E7Fh, 00002E9Ah, 00002E9Ah,\
	00002EF4h, 00002EFFh, 00002FD6h, 00002FEFh,\
	00002FFCh, 00002FFFh, 0000302Ah, 0000302Fh,\
	0000303Fh, 00003040h, 00003097h, 00003098h,\
	00003100h, 00003104h, 0000312Eh, 00003130h,\
	0000318Fh, 0000318Fh, 000031B8h, 000031BFh,\
	000031E4h, 000031EFh, 0000321Fh, 0000321Fh,\
	00003248h, 0000324Fh, 000032FFh, 000032FFh,\
	00004DC0h, 00004DFFh, 0000A48Dh, 0000A48Fh,\
	0000A4C7h, 0000A95Fh, 0000A97Dh, 0000ABFFh,\
	0000D7A4h, 0000D7AFh, 0000D7C7h, 0000D7CAh,\
	0000D7FCh, 0000D7FFh, 0000E000h, 0000E7C6h,\
	0000E7C9h, 0000F8FFh, 0000FB00h, 0000FB00h,\
	0000FB03h, 0000FE0Fh, 0000FE1Ah, 0000FE2Fh,\
	0000FE53h, 0000FE53h, 0000FE67h, 0000FE67h,\
	0000FE6Ch, 0000FEFEh, 0000FF00h, 0000FF00h,\
	0000FFA0h, 0000FFDFh, 0000FFE7h, 0000FFE7h,\
	0000FFEFh, 0000FFF8h, 0000FFFDh, 0000FFFDh,\
	00010000h, 0010FFFFh
    .size = $ - new_data

kernel = 1
include 'idata\hnt.inc'

.idata

include 'idata\it.inc'

bytes dd ?
